<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Farm√°cias Isoladas - Monitoramento RD</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f9; padding: 20px; color: #333; }
        .container { max-width: 650px; margin: auto; background: white; padding: 0; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background-color: #003366; color: white; padding: 25px; text-align: center; }
        .header h2 { margin: 0; font-size: 24px; letter-spacing: 1px; }
        .content { padding: 30px; }
        .input-group { margin-bottom: 25px; }
        label { font-weight: 600; display: block; margin-bottom: 8px; color: #555; }
        input { width: 100%; padding: 14px; border: 2px solid #e1e4e8; border-radius: 8px; box-sizing: border-box; font-size: 16px; transition: border-color 0.3s; }
        input:focus { border-color: #003366; outline: none; }
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 16px; }
        .btn-search { background-color: #003366; color: white; margin-top: 10px; }
        .btn-search:hover { background-color: #002244; transform: translateY(-1px); }
        .btn-email { background-color: #28a745; color: white; margin-top: 20px; display: none; box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); }
        .btn-email:hover { background-color: #218838; transform: translateY(-1px); }
        .result-box { margin-top: 20px; padding: 20px; background: #f8f9fa; border-left: 5px solid #003366; border-radius: 4px; display: none; line-height: 1.6; }
        .status-msg { margin-top: 15px; font-size: 14px; font-weight: bold; text-align: center; }
        strong { color: #003366; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>üì° Farm√°cias Isoladas</h2>
    </div>
    
    <div class="content">
        <p style="text-align: center; color: #666; margin-top: 0;">Consulte a filial pelo JAVA para gerar o acionamento.</p>
        
        <div class="input-group">
            <label for="javaInput">C√≥digo JAVA da Loja:</label>
            <input type="text" id="javaInput" placeholder="Ex: 5062" onkeypress="if(event.key === 'Enter') buscarLoja()">
            <button class="btn-search" onclick="buscarLoja()">üîç Consultar Base de Dados</button>
        </div>

        <div id="statusMsg" class="status-msg"></div>

        <div id="resultBox" class="result-box">
            <strong>üìç Filial:</strong> <span id="javaExibido"></span> - <span id="nomeLoja"></span><br>
            <strong>üè¢ Regional:</strong> <span id="regionalLoja"></span><br>
            <strong>üìß E-mail Loja:</strong> <span id="emailLoja"></span>
        </div>

        <button id="btnGerarEmail" class="btn-email" onclick="dispararEmail()">üìß Abrir E-mail no Outlook</button>
    </div>
</div>

<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRI6-DhrILv6HV1_Y-j2OvQgokSczW6N_M8ClinsID9zkHL_Vin-u86oy3aCUX1oZ_2fVp4fvsddoRm/pub?output=csv";
    let dadosEncontrados = null;

    async function buscarLoja() {
        const javaInput = document.getElementById('javaInput').value.trim();
        const status = document.getElementById('statusMsg');
        const resultBox = document.getElementById('resultBox');
        const btnEmail = document.getElementById('btnGerarEmail');

        if (!javaInput) {
            status.innerHTML = "‚ùå Digite um c√≥digo JAVA.";
            status.style.color = "red";
            return;
        }

        status.innerHTML = "‚è≥ Buscando informa√ß√µes...";
        status.style.color = "blue";

        try {
            const response = await fetch("https://corsproxy.io/?" + encodeURIComponent(CSV_URL));
            const data = await response.text();
            const linhas = data.split('\n').map(l => l.split(','));

            const loja = linhas.find(col => col[1] && col[1].trim() === javaInput);

            if (loja) {
                dadosEncontrados = {
                    java: loja[1].trim(),
                    nome: loja[3].trim(), 
                    email: loja[8].trim(), 
                    regional: loja[5].trim(), 
                    emailRegional: loja[6].trim() 
                };

                document.getElementById('javaExibido').innerText = dadosEncontrados.java;
                document.getElementById('nomeLoja').innerText = dadosEncontrados.nome;
                document.getElementById('regionalLoja').innerText = dadosEncontrados.emailRegional; // Exibe o e-mail da regional
                document.getElementById('emailLoja').innerText = dadosEncontrados.email;

                status.innerHTML = "‚úÖ Dados carregados com sucesso!";
                status.style.color = "green";
                resultBox.style.display = "block";
                btnEmail.style.display = "block";
            } else {
                status.innerHTML = "‚ö†Ô∏è JAVA n√£o encontrado na base.";
                status.style.color = "orange";
                resultBox.style.display = "none";
                btnEmail.style.display = "none";
            }
        } catch (error) {
            status.innerHTML = "‚ùå Erro ao conectar com a base de dados.";
            status.style.color = "red";
        }
    }

    function dispararEmail() {
        if (!dadosEncontrados) return;
        
        const agora = new Date().getHours();
        const saudacao = agora < 12 ? "boa manh√£" : (agora < 18 ? "boa tarde" : "boa noite");
        
        const destinatario = dadosEncontrados.email;
        // O campo CC usa o e-mail da regional e o monitoramento
        const cc = `${dadosEncontrados.emailRegional}; suportemonitoramento@rdsaude.com.br`;
        
        const assunto = encodeURIComponent(`Desligamento de Servi√ßos - Filial ${dadosEncontrados.java} ‚Äì ${dadosEncontrados.nome}`);
        
        const corpoTexto = `Prezados, ${saudacao}!\n\n` +
            `Encaminhamos este e-mail para informar que os servi√ßos da Filial ${dadosEncontrados.java} ‚Äì ${dadosEncontrados.nome} foram desligados devido √† identifica√ß√£o de um erro sist√™mico em nosso radar (farm√°cias isoladas), bem como √† aus√™ncia de registros de atendimentos no TC/TR na √∫ltima hora.\n\n` +
            `Solicitamos, por gentileza, que ap√≥s a normaliza√ß√£o do cen√°rio, para a reativa√ß√£o dos servi√ßos, entrem em contato com o Suporte √† Loja por meio do chat.\n\n` +
            `Em caso de d√∫vidas, permanecemos √† disposi√ß√£o pelos canais de Suporte √† Loja, dispon√≠veis 24 horas por dia, todos os dias da semana, por meio do link abaixo:\n` +
            `https://grupordprod.service-now.com/esc\n\n` +
            `Atenciosamente,`;

        window.location.href = `mailto:${destinatario}?cc=${cc}&subject=${assunto}&body=${encodeURIComponent(corpoTexto)}`;
    }
</script>
</body>
</html>
