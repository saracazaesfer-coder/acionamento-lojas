<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Acionamento - Monitoramento RD</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 700px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #0052cc; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .input-group { margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-search { background-color: #0052cc; color: white; margin-top: 10px; }
        .btn-search:hover { background-color: #003d99; }
        .btn-email { background-color: #28a745; color: white; margin-top: 20px; display: none; }
        .btn-email:hover { background-color: #218838; }
        .result-box { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px; border: 1px solid #eee; display: none; }
        .status-msg { margin-top: 10px; font-size: 14px; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <h2>üöÄ Gerador de Acionamento</h2>
    <p>Consulte a loja pelo JAVA para gerar o e-mail de desligamento.</p>
    <div class="input-group">
        <label for="javaInput">C√≥digo JAVA da Loja:</label>
        <input type="text" id="javaInput" placeholder="Ex: 3041">
        <button class="btn-search" onclick="buscarLoja()">Consultar Base de Dados</button>
    </div>
    <div id="statusMsg" class="status-msg"></div>
    <div id="resultBox" class="result-box">
        <strong>Loja encontrada:</strong> <span id="nomeLoja"></span><br>
        <strong>Regional:</strong> <span id="regionalLoja"></span><br>
        <strong>E-mail:</strong> <span id="emailLoja"></span>
    </div>
    <button id="btnGerarEmail" class="btn-email" onclick="dispararEmail()">üìß Abrir E-mail no Outlook</button>
</div>
<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRI6-DhrILv6HV1_Y-j2OvQgokSczW6N_M8ClinsID9zkHL_Vin-u86oy3aCUX1oZ_2fVp4fvsddoRm/pub?output=csv";
    let dadosEncontrados = null;

    async function buscarLoja() {
        const javaInput = document.getElementById('javaInput').value.trim();
        const status = document.getElementById('statusMsg');
        const resultBox = document.getElementById('resultBox');
        const btnEmail = document.getElementById('btnGerarEmail');

        if (!javaInput) {
            status.innerHTML = "‚ùå Digite um c√≥digo JAVA.";
            status.style.color = "red";
            return;
        }

        status.innerHTML = "‚è≥ Buscando informa√ß√µes...";
        status.style.color = "blue";

        try {
            const response = await fetch("https://corsproxy.io/?" + encodeURIComponent(CSV_URL));
            const data = await response.text();
            const linhas = data.split('\n').map(l => l.split(','));

            const loja = linhas.find(col => col[1] && col[1].trim() === javaInput);

            if (loja) {
                dadosEncontrados = {
                    java: loja[1].trim(),
                    nome: loja[3].trim(), 
                    email: loja[8].trim(), 
                    regional: loja[5].trim(), 
                    emailRegional: loja[6].trim() 
                };

                document.getElementById('nomeLoja').innerText = dadosEncontrados.nome;
                document.getElementById('regionalLoja').innerText = dadosEncontrados.regional;
                document.getElementById('emailLoja').innerText = dadosEncontrados.email;

                status.innerHTML = "‚úÖ Loja localizada!";
                status.style.color = "green";
                resultBox.style.display = "block";
                btnEmail.style.display = "block";
            } else {
                status.innerHTML = "‚ö†Ô∏è JAVA n√£o encontrado na base.";
                status.style.color = "orange";
                resultBox.style.display = "none";
                btnEmail.style.display = "none";
            }
        } catch (error) {
            status.innerHTML = "‚ùå Erro ao conectar com a base de dados.";
            status.style.color = "red";
        }
    }

    function dispararEmail() {
        if (!dadosEncontrados) return;
        const saudacao = new Date().getHours() < 12 ? "Bom dia" : (new Date().getHours() < 18 ? "Boa tarde" : "Boa noite");
        const destinatario = dadosEncontrados.email;
        const cc = `${dadosEncontrados.emailRegional}; suportemonitoramento@rdsaude.com.br`;
        const assunto = `Desligamento de Servi√ßos - Loja Java: ${dadosEncontrados.java}`;
        const corpo = `Prezados, ${saudacao}.%0D%0A%0D%0A` +
            `Informo que os servi√ßos da loja ${dadosEncontrados.java} foram desligados, identificamos em nossos radares que a mesma pode estar sem energia ou internet.%0D%0A%0D%0A` +
            `Solicitamos, por gentileza, que entrem em contato com o Suporte Multicanal via chat para a reativa√ß√£o dos servi√ßos, atrav√©s deste link:%0D%0A` +
            `https://grupordprod.service-now.com/esc%0D%0A%0D%0A` +
            `Em caso de d√∫vidas, permanecemos √† disposi√ß√£o pelos canais de Suporte Multicanal, dispon√≠veis 24 horas por dia, todos os dias da semana.%0D%0A%0D%0A` +
            `Atenciosamente,`;

        window.location.href = `mailto:${destinatario}?cc=${cc}&subject=${assunto}&body=${corpo}`;
    }
</script>
</body>
</html>